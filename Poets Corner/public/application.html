<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/header.css"/>
    <link rel="stylesheet" href="css/head.css"/>
    <link rel="stylesheet" href="css/footer.css"/>
    <link rel="stylesheet" href="css/recentPosts.css"/>
</head>
<body>
    <div id="wrapper">
        <nav>
            <div class="logo">
                <a href="application.html"><h1 class="headerTitle">Poets Corner</h1></a>
            </div>
            <ul>
                <li><a href="profile.html">Profile</a></li>
                <li><a href="post.html">Write a Poem</a></li>
            </ul>
            <div class="hamburger">
                <span class="line"></span>
                <span class="line"></span>
                <span class="line"></span>
            </div>
        </nav>
        <div class="menubar">
            <ul>
                <li><a href="profile.html">Profile</a></li>
                <li><a href="post.html">Write a Poem</a></li>
            </ul>
        </div>
        <section id="main">
            <div class="inner">
                <div>
                    <div class="square">
                        <ul id="recent-posts"></ul>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script href="js/header.js"></script>
    <script>
        let recentPosts = [];
        let recentPostsList = document.querySelector('#recent-posts');
        
        fetch('/getposts')
            .then(response => response.json())
            .then(fetchedData => {
                recentPosts = fetchedData.posts;
                handleServerData();
            });
        
        function handleServerData() {
            recentPostsList.innerHTML = '';
            recentPosts.forEach(function(post) {
                let li = document.createElement('li');
                let postContainer = document.createElement('div');
                postContainer.classList.add('post-container');
                let postedByDiv = document.createElement('div');
                postedByDiv.classList.add('posted-by');
                postedByDiv.textContent = `Posted by: ${post.postedBy}`;
                postContainer.appendChild(postedByDiv);
                let textContainer = document.createElement('div');
                textContainer.classList.add('text-container');
                let postText = document.createElement('p');
                postText.textContent = `${post.message}`;
                textContainer.appendChild(postText);
                textContainer.style.whiteSpace = 'pre-wrap';
                let textHeight = getTextHeight(post.message);
                textContainer.style.height = `${textHeight}px`;
                postContainer.appendChild(textContainer);
                let likeButton = document.createElement('button');
                likeButton.classList.add('like-button');
                likeButton.innerHTML = `<span class="star">&#9733;</span> (${post.likes})`; 
                likeButton.addEventListener('click', () => handleLikeButtonClick(post._id));
                postContainer.appendChild(likeButton);  
                li.appendChild(postContainer);
                recentPostsList.appendChild(li);
            });
        }
        
        function getTextHeight(text) {
            let tempElement = document.createElement('div');
            tempElement.style.visibility = 'hidden';
            tempElement.style.position = 'absolute';
            tempElement.style.width = '200px';
            tempElement.style.wordWrap = 'break-word';
            tempElement.style.whiteSpace = 'pre-wrap';
            tempElement.textContent = text;
            document.body.appendChild(tempElement);
            let height = tempElement.offsetHeight;
            document.body.removeChild(tempElement);
            return height;
        }
        
        function handleLikeButtonClick(postId) {
            fetch(`/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ postId: postId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetch('/getposts')
                        .then(response => response.json())
                        .then(fetchedData => {
                            recentPosts = fetchedData.posts;
                            handleServerData();
                        });
                }
            });
        }
    </script>
</body>
</html>
